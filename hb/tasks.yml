# hb/tasks.yml - 任务定义

tasks:
  # 任务1: 合并节点文件
  merge_nodes:
    name: "合并节点文件"
    description: "将nodes目录下的所有txt/yaml文件合并"
    enabled: true
    
    steps:
      - id: "scan_files"
        action: "scan_directory"
        params:
          directory: "${directories.source}"
          patterns: "${files.patterns.nodes}"
          
      - id: "read_files"
        action: "read_files"
        params:
          files: "${scan_files.result}"
          encoding: "utf-8"
          
      - id: "merge_content"
        action: "merge_contents"
        params:
          contents: "${read_files.result}"
          add_headers: "${processing.merge.add_header}"
          
      - id: "write_merged"
        action: "write_file"
        params:
          path: "${directories.output}/${files.output_files.merged_txt}"
          content: "${merge_content.result}"
          
    outputs:
      - name: "merged_file"
        value: "${directories.output}/${files.output_files.merged_txt}"
        
  # 任务2: 按协议拆分
  split_by_protocol:
    name: "按协议拆分"
    description: "将合并文件按协议类型拆分"
    enabled: true
    depends_on: "merge_nodes"
    
    steps:
      - id: "read_merged"
        action: "read_file"
        params:
          path: "${tasks.merge_nodes.outputs.merged_file}"
          
      - id: "split_lines"
        action: "split_by_protocol"
        params:
          content: "${read_merged.result}"
          protocols: "${processing.split.protocols}"
          
      - id: "write_splits"
        action: "write_files"
        params:
          base_path: "${directories.output}"
          files: "${split_lines.result}"
          
    outputs:
      - name: "protocol_files"
        value: "${split_lines.result.filenames}"
        
  # 任务3: 验证节点可用性
  validate_nodes:
    name: "验证节点"
    description: "验证节点的可用性"
    enabled: "${processing.validate.enable}"
    depends_on: "split_by_protocol"
    
    steps:
      - id: "load_nodes"
        action: "load_protocol_files"
        params:
          directory: "${directories.output}"
          protocols: "${processing.split.protocols}"
          
      - id: "validate"
        action: "validate_urls"
        params:
          urls: "${load_nodes.result}"
          timeout: "${processing.validate.timeout}"
          
      - id: "generate_report"
        action: "generate_validation_report"
        params:
          results: "${validate.result}"
          
    outputs:
      - name: "validation_report"
        value: "${directories.output}/validation_report.json"
        
  # 任务4: 备份处理结果
  backup_results:
    name: "备份结果"
    description: "备份处理结果文件"
    enabled: "${backup.enable}"
    depends_on: ["merge_nodes", "split_by_protocol"]
    
    steps:
      - id: "collect_files"
        action: "collect_output_files"
        params:
          directory: "${directories.output}"
          
      - id: "create_backup"
        action: "create_backup"
        params:
          files: "${collect_files.result}"
          backup_dir: "${directories.backup}"
          compress: "${backup.compress}"
          
    outputs:
      - name: "backup_file"
        value: "${create_backup.result}"
